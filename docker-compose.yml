#!/usr/bin/env bash
set -euo pipefail  # Exit on error, undefined vars, pipe failures

readonly SCRIPT_NAME="BladeMedia Setup"
readonly DIRS=(
  'media/movies'
  'media/tv'
  'downloads/incomplete'
  'downloads/complete'
  'downloads/jackett'
  'tdarr_cache'
)

print_banner() {
  printf '\n\033[1;36m%s\033[0m\n' "========================================"
  printf '%s\n'     "$SCRIPT_NAME v1.0"
  printf '\033[1;36m%s\033[0m\n' "========================================"
}

print_next_steps() {
  local root="$1"
  printf '\n\033[1;32mNext Steps:\033[0m\n'
  printf '  cd %s\n' "$root"
  printf '  docker compose up -d\n\n'
  printf '\033[1;33mAccess via browser (replace SERVER_IP):\033[0m\n'
  printf '  Jellyfin:     http://SERVER_IP:8096\n'
  printf '  MediaManager: http://SERVER_IP:8787\n'
  printf '  Wizarr:       http://SERVER_IP:5690\n'
}

main() {
  print_banner
  
  local root
  read -rp $'\033[1;33mEnter root path (e.g. /srv/blademedia): \033[0m' root
  
  if [[ -z "$root" ]]; then
    printf '\033[1;31mError: Root path cannot be empty.\033[0m\n' >&2
    exit 1
  fi

  if [[ ! "$root" =~ ^/ ]]; then
    printf '\033[1;31mError: %s must be absolute path\033[0m\n' "$root" >&2
    exit 1
  fi

  printf '\n\033[1;32mUsing root: %s\033[0m\n' "$root"

  # Create all dirs in single brace expansion (fastest)
  printf 'Creating BladeMedia directory structure...\n'
  local full_paths=()
  for dir in "${DIRS[@]}"; do
    full_paths+=("$root/$dir")
  done
  mkdir -p "${full_paths[@]}"
  printf 'âœ… %d directories created\n' "${#full_paths[@]}"

  local compose_file="$root/docker-compose.yml"
  printf 'Writing %s...\n' "$compose_file"

  # Generate docker-compose.yml with clean variable substitution
  cat > "$compose_file" <<EOF
version: "3.9"

networks:
  media:
    driver: bridge

volumes:
  jellyfin_cache:
  jellyfin_config:
  jackett_config:
  rdtclient_config:
  bazarr_config:
  tdarr_config:
  tdarr_logs:
  tdarr_server_config:
  mediamanager_config:
  wizarr_config:

services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: blademedia-jellyfin
    networks: [media]
    user: "0:0"
    environment: [TZ=Etc/UTC]
    volumes:
      - jellyfin_config:/config
      - jellyfin_cache:/cache
      - ${root}/media:/media
    ports: ["8096:8096"]
    restart: unless-stopped

  jackett:
    image: lscr.io/linuxserver/jackett:latest
    container_name: blademedia-jackett
    networks: [media]
    environment:
      - PUID=0
      - PGID=0
      - TZ=Etc/UTC
    volumes:
      - jackett_config:/config
      - ${root}/downloads/jackett:/downloads
    ports: ["9117:9117"]
    restart: unless-stopped

  rdtclient:
    image: rogerfar/rdtclient:latest
    container_name: blademedia-rdtclient
    networks: [media]
    environment:
      - PUID=0
      - PGID=0
      - TZ=Etc/UTC
    volumes:
      - rdtclient_config:/data/db
      - ${root}/downloads:/data/downloads
    ports: ["6500:6500"]
    restart: unless-stopped

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: blademedia-flaresolverr
    networks: [media]
    environment:
      - LOG_LEVEL=info
      - LOG_HTML=false
      - CAPTCHA_SOLVER=none
      - TZ=Etc/UTC
    ports: ["8191:8191"]
    restart: unless-stopped

  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: blademedia-bazarr
    networks: [media]
    environment:
      - PUID=0
      - PGID=0
      - TZ=Etc/UTC
    volumes:
      - bazarr_config:/config
      - ${root}/media:/media
    ports: ["6767:6767"]
    restart: unless-stopped

  tdarr:
    image: ghcr.io/tdarr/tdarr:latest
    container_name: blademedia-tdarr
    networks: [media]
    environment:
      - PUID=0
      - PGID=0
      - TZ=Etc/UTC
      - serverIP=0.0.0.0
      - serverPort=8266
      - webUIPort=8265
    volumes:
      - tdarr_config:/app/configs
      - tdarr_logs:/app/logs
      - tdarr_server_config:/app/server
      - ${root}/media:/media
      - ${root}/tdarr_cache:/temp
    ports:
      - "8265:8265"
      - "8266:8266"
    restart: unless-stopped

  mediamanager:
    image: ghcr.io/maxdorninger/mediamanager:latest
    container_name: blademedia-mediamanager
    networks: [media]
    environment: [TZ=Etc/UTC]
    volumes:
      - mediamanager_config:/app/data
      - ${root}/media:/media
    ports: ["8787:8787"]
    restart: unless-stopped

  wizarr:
    image: ghcr.io/wizarrrr/wizarr:latest
    container_name: blademedia-wizarr
    networks: [media]
    environment: [TZ=Etc/UTC]
    volumes: [wizarr_config:/data]
    ports: ["5690:5690"]
    restart: unless-stopped
EOF

  printf 'âœ… BladeMedia docker-compose.yml created\n'
  print_next_steps "$root"
  printf '\n\033[1;36mBladeMedia setup complete! ðŸŽ¬\033[0m\n'
}

main
